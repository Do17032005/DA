<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Thanh toán</title>
</head>
<body>
    <main layout:fragment="content">
        <div class="container my-5">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/}">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/cart}">Giỏ hàng</a></li>
                    <li class="breadcrumb-item active">Thanh toán</li>
                </ol>
            </nav>

            <!-- Checkout Steps -->
            <div class="row mb-4">
                <div class="col-12">
                    <ul class="nav nav-pills nav-fill">
                        <li class="nav-item">
                            <a class="nav-link" href="/cart">
                                <i class="fas fa-shopping-cart"></i> Giỏ hàng
                            </a>
                        </li>
                        <li class="nav-item">
                            <span class="nav-link active">
                                <i class="fas fa-shipping-fast"></i> Thông tin giao hàng
                            </span>
                        </li>
                        <li class="nav-item">
                            <span class="nav-link disabled">
                                <i class="fas fa-credit-card"></i> Thanh toán
                            </span>
                        </li>
                        <li class="nav-item">
                            <span class="nav-link disabled">
                                <i class="fas fa-check-circle"></i> Hoàn thành
                            </span>
                        </li>
                    </ul>
                </div>
            </div>

            <form th:action="@{/orders/checkout}" method="post" id="checkoutForm">
                <div class="row">
                    <!-- Left Column: Shipping & Payment Info -->
                    <div class="col-lg-8">
                        <!-- Customer Information -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-user me-2"></i>Thông tin người nhận
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">
                                            Họ và tên <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" name="fullName" 
                                               required placeholder="Nguyễn Văn A"
                                               th:value="${session.fullName}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">
                                            Số điện thoại <span class="text-danger">*</span>
                                        </label>
                                        <input type="tel" class="form-control" name="phone" 
                                               required placeholder="0123456789"
                                               pattern="[0-9]{10}"
                                               th:value="${session.phone}">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Email <span class="text-danger">*</span>
                                    </label>
                                    <input type="email" class="form-control" name="email" 
                                           required placeholder="example@email.com"
                                           th:value="${session.email}">
                                </div>

                                <!-- Saved Addresses -->
                                <div class="mb-3" th:if="${savedAddresses != null && !savedAddresses.empty}">
                                    <label class="form-label">Chọn địa chỉ đã lưu</label>
                                    <select class="form-select" id="savedAddressSelect" onchange="loadAddress()">
                                        <option value="">-- Nhập địa chỉ mới --</option>
                                        <option th:each="addr : ${savedAddresses}" 
                                                th:value="${addr.addressId}"
                                                th:text="${addr.fullAddress}">
                                            Address
                                        </option>
                                    </select>
                                    <input type="hidden" name="addressId" id="addressIdInput">
                                </div>

                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">
                                            Tỉnh/Thành phố <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" name="province" id="province" 
                                                required onchange="loadDistricts()">
                                            <option value="">-- Chọn --</option>
                                            <option value="Hà Nội">Hà Nội</option>
                                            <option value="TP.HCM">TP. Hồ Chí Minh</option>
                                            <option value="Đà Nẵng">Đà Nẵng</option>
                                            <option value="Hải Phòng">Hải Phòng</option>
                                            <option value="Cần Thơ">Cần Thơ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">
                                            Quận/Huyện <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" name="district" id="district" 
                                                required onchange="loadWards()">
                                            <option value="">-- Chọn --</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">
                                            Phường/Xã <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" name="ward" id="ward" required>
                                            <option value="">-- Chọn --</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Địa chỉ cụ thể <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" name="address" 
                                           required placeholder="Số nhà, tên đường...">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Ghi chú đơn hàng (tùy chọn)</label>
                                    <textarea class="form-control" name="note" rows="3" 
                                              placeholder="Ghi chú về đơn hàng, ví dụ: thời gian hay chỉ dẫn địa điểm giao hàng chi tiết hơn."></textarea>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="saveAddress" name="saveAddress">
                                    <label class="form-check-label" for="saveAddress">
                                        Lưu địa chỉ này cho lần mua sau
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-credit-card me-2"></i>Phương thức thanh toán
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- COD -->
                                <div class="form-check mb-3 p-3 border rounded">
                                    <input class="form-check-input" type="radio" name="paymentMethod" 
                                           value="COD" id="paymentCOD" checked>
                                    <label class="form-check-label w-100" for="paymentCOD">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-money-bill-wave fa-2x text-success me-3"></i>
                                            <div>
                                                <strong>Thanh toán khi nhận hàng (COD)</strong>
                                                <p class="small text-muted mb-0">
                                                    Thanh toán bằng tiền mặt khi nhận hàng
                                                </p>
                                            </div>
                                        </div>
                                    </label>
                                </div>

                                <!-- Bank Transfer -->
                                <div class="form-check mb-3 p-3 border rounded">
                                    <input class="form-check-input" type="radio" name="paymentMethod" 
                                           value="BANK" id="paymentBank">
                                    <label class="form-check-label w-100" for="paymentBank">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-university fa-2x text-primary me-3"></i>
                                            <div>
                                                <strong>Chuyển khoản ngân hàng</strong>
                                                <p class="small text-muted mb-0">
                                                    Chuyển khoản qua STK: 
                                                    <strong th:text="${@settingsService.getSetting('bank_account_number', '1900123456789')}"></strong>
                                                    - <span th:text="${@settingsService.getSetting('bank_name', 'Techcombank')}"></span>
                                                </p>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                                <!-- MoMo -->
                                <div class="form-check mb-3 p-3 border rounded" 
                                     th:if="${@settingsService.getSettingAsBoolean('payment_momo_enabled', false)}">
                                    <input class="form-check-input" type="radio" name="paymentMethod" 
                                           value="MOMO" id="paymentMomo">
                                    <label class="form-check-label w-100" for="paymentMomo">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-mobile-alt fa-2x text-danger me-3"></i>
                                            <div>
                                                <strong>Ví MoMo</strong>
                                                <p class="small text-muted mb-0">
                                                    Thanh toán qua ví điện tử MoMo
                                                </p>
                                            </div>
                                        </div>
                                    </label>
                                </div>

                                <!-- VNPay -->
                                <div class="form-check mb-3 p-3 border rounded" 
                                     th:if="${@settingsService.getSettingAsBoolean('payment_vnpay_enabled', false)}">
                                    <input class="form-check-input" type="radio" name="paymentMethod" 
                                           value="VNPAY" id="paymentVnpay">
                                    <label class="form-check-label w-100" for="paymentVnpay">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-qrcode fa-2x text-info me-3"></i>
                                            <div>
                                                <strong>VNPay</strong>
                                                <p class="small text-muted mb-0">
                                                    Thanh toán qua cổng VNPay
                                                </p>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Order Summary -->
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-receipt me-2"></i>Đơn hàng của bạn
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Order Items -->
                                <div class="mb-3" style="max-height: 300px; overflow-y: auto;">
                                    <div class="d-flex mb-3 pb-3 border-bottom" th:each="item : ${cartItems}">
                                        <img th:src="${item.imageUrl}" 
                                             th:alt="${item.productName}"
                                             class="rounded" 
                                             style="width: 60px; height: 60px; object-fit: cover;">
                                        <div class="ms-3 flex-grow-1">
                                            <h6 class="mb-1 small" th:text="${item.productName}">Product</h6>
                                            <small class="text-muted">
                                                <span th:if="${item.size != null}" th:text="'Size: ' + ${item.size}"></span>
                                                <span th:if="${item.color != null}" th:text="', ' + ${item.color}"></span>
                                            </small>
                                            <div class="d-flex justify-content-between mt-1">
                                                <small th:text="'SL: ' + ${item.quantity}">x1</small>
                                                <strong class="text-danger small" 
                                                        th:text="${#numbers.formatDecimal(item.price * item.quantity, 0, 0)} + 'đ'">
                                                    299,000đ
                                                </strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Voucher -->
                                <div class="mb-3">
                                    <label class="form-label small">Mã giảm giá</label>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" name="voucherCode" 
                                               id="voucherCodeCheckout"
                                               placeholder="Nhập mã"
                                               th:value="${appliedVoucher != null ? appliedVoucher.code : ''}">
                                        <button class="btn btn-outline-primary" type="button" 
                                                onclick="applyVoucherCheckout()">
                                            Áp dụng
                                        </button>
                                    </div>
                                </div>

                                <hr>

                                <!-- Price Summary -->
                                <div class="mb-2 d-flex justify-content-between small">
                                    <span>Tạm tính:</span>
                                    <strong th:text="${#numbers.formatDecimal(subtotal, 0, 0)} + 'đ'">598,000đ</strong>
                                </div>

                                <div class="mb-2 d-flex justify-content-between small" th:if="${discount > 0}">
                                    <span>Giảm giá:</span>
                                    <strong class="text-success">
                                        -<span th:text="${#numbers.formatDecimal(discount, 0, 0)}">50,000</span>đ
                                    </strong>
                                </div>

                                <div class="mb-3 d-flex justify-content-between small">
                                    <span>Phí vận chuyển:</span>
                                    <span>
                                        <span th:if="${shippingFee > 0}" 
                                              th:text="${#numbers.formatDecimal(shippingFee, 0, 0)} + 'đ'">
                                            30,000đ
                                        </span>
                                        <span th:if="${shippingFee == 0}" class="text-success">Miễn phí</span>
                                    </span>
                                </div>

                                <hr>

                                <div class="mb-4 d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Tổng cộng:</h5>
                                    <h4 class="mb-0 text-danger" 
                                        th:text="${#numbers.formatDecimal(total, 0, 0)} + 'đ'">
                                        628,000đ
                                    </h4>
                                </div>

                                <!-- Terms -->
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                    <label class="form-check-label small" for="agreeTerms">
                                        Tôi đã đọc và đồng ý với 
                                        <a href="/policy-privacy" target="_blank">điều khoản & chính sách</a>
                                    </label>
                                </div>

                                <!-- Submit Button -->
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-danger btn-lg">
                                        <i class="fas fa-check-circle me-2"></i>
                                        Đặt hàng
                                    </button>
                                    <a href="/cart" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-1"></i>Quay lại giỏ hàng
                                    </a>
                                </div>
                            </div>

                            <!-- Security Badges -->
                            <div class="card-footer bg-light">
                                <div class="text-center small text-muted">
                                    <i class="fas fa-lock me-1"></i>
                                    Giao dịch bảo mật & an toàn
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <th:block layout:fragment="scripts">
        <script>
            function loadAddress() {
                const addressId = $('#savedAddressSelect').val();
                $('#addressIdInput').val(addressId);
                
                if (!addressId) {
                    $('#checkoutForm')[0].reset();
                    return;
                }

                $.get('/user/address/' + addressId, function(addr) {
                    $('input[name="fullName"]').val(addr.fullName);
                    $('input[name="phone"]').val(addr.phone);
                    $('#province').val(addr.province).trigger('change');
                    setTimeout(() => {
                        $('#district').val(addr.district).trigger('change');
                        setTimeout(() => {
                            $('#ward').val(addr.ward);
                        }, 200);
                    }, 200);
                    $('input[name="address"]').val(addr.address);
                });
            }

            function loadDistricts() {
                const province = $('#province').val();
                const districtSelect = $('#district');
                const wardSelect = $('#ward');
                
                // Reset
                districtSelect.html('<option value="">-- Chọn --</option>');
                wardSelect.html('<option value="">-- Chọn --</option>');
                
                if (!province) return;

                // Load districts via API
                $.get('/addresses/api/districts?province=' + encodeURIComponent(province), function(districts) {
                    districts.forEach(function(d) {
                        districtSelect.append(`<option value="${d}">${d}</option>`);
                    });
                });
            }

            function loadWards() {
                const district = $('#district').val();
                const wardSelect = $('#ward');
                
                // Reset
                wardSelect.html('<option value="">-- Chọn --</option>');
                
                if (!district) return;

                // Load wards via API
                $.get('/addresses/api/wards?district=' + encodeURIComponent(district), function(wards) {
                    wards.forEach(function(w) {
                        wardSelect.append(`<option value="${w}">${w}</option>`);
                    });
                });
            }

            function applyVoucherCheckout() {
                const code = $('#voucherCodeCheckout').val();
                if (!code) {
                    showNotification('Vui lòng nhập mã giảm giá!', 'warning');
                    return;
                }

                $.post('/cart/apply-voucher', { code: code }, function(response) {
                    if (response.success) {
                        showNotification('Áp dụng mã thành công!', 'success');
                        location.reload();
                    } else {
                        showNotification(response.message || 'Mã không hợp lệ!', 'error');
                    }
                });
            }

            // Form validation
            $('#checkoutForm').on('submit', function(e) {
                const phone = $('input[name="phone"]').val();
                if (!/^[0-9]{10}$/.test(phone)) {
                    e.preventDefault();
                    showNotification('Số điện thoại không hợp lệ!', 'error');
                    return false;
                }
            });
        </script>
    </th:block>
</body>
</html>
