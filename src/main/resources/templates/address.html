<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Địa chỉ giao hàng</title>
</head>
<body>
    <main layout:fragment="content">
        <div class="container my-5">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/}">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/user/profile}">Tài khoản</a></li>
                    <li class="breadcrumb-item active">Địa chỉ</li>
                </ol>
            </nav>

            <div class="row">
                <!-- Sidebar Menu -->
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                <a href="/user/profile" class="list-group-item list-group-item-action">
                                    <i class="fas fa-user me-2"></i>Thông tin tài khoản
                                </a>
                                <a href="/user/orders" class="list-group-item list-group-item-action">
                                    <i class="fas fa-box me-2"></i>Đơn hàng của tôi
                                </a>
                                <a href="/user/address" class="list-group-item list-group-item-action active">
                                    <i class="fas fa-map-marker-alt me-2"></i>Địa chỉ giao hàng
                                </a>
                                <a href="/user/vouchers" class="list-group-item list-group-item-action">
                                    <i class="fas fa-ticket-alt me-2"></i>Voucher của tôi
                                </a>
                                <a href="/wishlist" class="list-group-item list-group-item-action">
                                    <i class="fas fa-heart me-2"></i>Sản phẩm yêu thích
                                </a>
                                <a href="/user/change-password" class="list-group-item list-group-item-action">
                                    <i class="fas fa-lock me-2"></i>Đổi mật khẩu
                                </a>
                                <a href="/logout" class="list-group-item list-group-item-action text-danger">
                                    <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-md-9">
                    <!-- Page Title -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>
                            <i class="fas fa-map-marker-alt me-2"></i>Địa chỉ giao hàng
                        </h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                            <i class="fas fa-plus me-1"></i>Thêm địa chỉ mới
                        </button>
                    </div>

                    <!-- Empty State -->
                    <div class="text-center py-5" th:if="${addresses == null || addresses.empty}">
                        <i class="fas fa-map-marked-alt fa-5x text-muted mb-4"></i>
                        <h4>Chưa có địa chỉ giao hàng</h4>
                        <p class="text-muted mb-4">Thêm địa chỉ để thanh toán nhanh hơn</p>
                        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                            <i class="fas fa-plus me-2"></i>Thêm địa chỉ
                        </button>
                    </div>

                    <!-- Address List -->
                    <div class="row" th:if="${addresses != null && !addresses.empty}">
                        <div class="col-md-6 mb-3" th:each="address : ${addresses}">
                            <div class="card border-0 shadow-sm h-100" 
                                 th:classappend="${address.isDefault ? 'border-primary' : ''}">
                                <div class="card-body">
                                    <!-- Default Badge -->
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <span class="badge bg-primary" th:if="${address.isDefault}">
                                            <i class="fas fa-star me-1"></i>Mặc định
                                        </span>
                                        <div class="dropdown" th:if="${!address.isDefault}">
                                            <button class="btn btn-sm btn-light dropdown-toggle" 
                                                    type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <a class="dropdown-item" href="#" 
                                                       th:onclick="'setDefault(' + ${address.addressId} + ')'">
                                                        <i class="fas fa-star me-2"></i>Đặt làm mặc định
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="#" 
                                                       th:onclick="'editAddress(' + ${address.addressId} + ')'">
                                                        <i class="fas fa-edit me-2"></i>Chỉnh sửa
                                                    </a>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <a class="dropdown-item text-danger" href="#" 
                                                       th:onclick="'deleteAddress(' + ${address.addressId} + ')'">
                                                        <i class="fas fa-trash me-2"></i>Xóa
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- Address Info -->
                                    <h6 class="mb-2">
                                        <i class="fas fa-user me-2 text-muted"></i>
                                        <span th:text="${address.fullName}">Nguyễn Văn A</span>
                                    </h6>
                                    <p class="mb-2">
                                        <i class="fas fa-phone me-2 text-muted"></i>
                                        <span th:text="${address.phone}">0123456789</span>
                                    </p>
                                    <p class="mb-0">
                                        <i class="fas fa-map-marker-alt me-2 text-muted"></i>
                                        <span th:text="${address.fullAddress}">
                                            123 Đường ABC, Phường XYZ, Quận 1, TP. Hồ Chí Minh
                                        </span>
                                    </p>

                                    <!-- Actions -->
                                    <div class="mt-3 pt-3 border-top" th:if="${address.isDefault}">
                                        <button class="btn btn-sm btn-outline-primary" 
                                                th:onclick="'editAddress(' + ${address.addressId} + ')'">
                                            <i class="fas fa-edit me-1"></i>Chỉnh sửa
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Address Modal -->
        <div class="modal fade" id="addAddressModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-plus-circle me-2"></i>Thêm địa chỉ mới
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form th:action="@{/user/address/add}" method="post" id="addAddressForm">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="fullName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" name="phone" 
                                           required pattern="[0-9]{10}">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Tỉnh/Thành phố <span class="text-danger">*</span></label>
                                    <select class="form-select" name="province" id="addProvince" required
                                            onchange="loadDistrictsAdd()">
                                        <option value="">-- Chọn Tỉnh/TP --</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Quận/Huyện <span class="text-danger">*</span></label>
                                    <select class="form-select" name="district" id="addDistrict" required
                                            onchange="loadWardsAdd()">
                                        <option value="">-- Chọn Quận/Huyện --</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Phường/Xã <span class="text-danger">*</span></label>
                                    <select class="form-select" name="ward" id="addWard" required>
                                        <option value="">-- Chọn Phường/Xã --</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Địa chỉ chi tiết <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="addressDetail" 
                                       placeholder="Số nhà, tên đường..." required>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="isDefault" 
                                       id="addIsDefault" value="true">
                                <label class="form-check-label" for="addIsDefault">
                                    Đặt làm địa chỉ mặc định
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Hủy
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Lưu địa chỉ
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Address Modal -->
        <div class="modal fade" id="editAddressModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-edit me-2"></i>Chỉnh sửa địa chỉ
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form th:action="@{/user/address/update}" method="post" id="editAddressForm">
                        <input type="hidden" name="addressId" id="editAddressId">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="fullName" 
                                           id="editFullName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" name="phone" 
                                           id="editPhone" required pattern="[0-9]{10}">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Tỉnh/Thành phố <span class="text-danger">*</span></label>
                                    <select class="form-select" name="province" id="editProvince" required
                                            onchange="loadDistrictsEdit()">
                                        <option value="">-- Chọn Tỉnh/TP --</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Quận/Huyện <span class="text-danger">*</span></label>
                                    <select class="form-select" name="district" id="editDistrict" required
                                            onchange="loadWardsEdit()">
                                        <option value="">-- Chọn Quận/Huyện --</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Phường/Xã <span class="text-danger">*</span></label>
                                    <select class="form-select" name="ward" id="editWard" required>
                                        <option value="">-- Chọn Phường/Xã --</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Địa chỉ chi tiết <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="addressDetail" 
                                       id="editAddressDetail" placeholder="Số nhà, tên đường..." required>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="isDefault" 
                                       id="editIsDefault" value="true">
                                <label class="form-check-label" for="editIsDefault">
                                    Đặt làm địa chỉ mặc định
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Hủy
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Cập nhật
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <th:block layout:fragment="scripts">
        <script>
            // Load provinces on page load
            $(document).ready(function() {
                loadProvinces();
            });

            function loadProvinces() {
                // TODO: Call API to get provinces
                // Placeholder data
                const provinces = [
                    {id: 1, name: 'Hà Nội'},
                    {id: 2, name: 'TP. Hồ Chí Minh'},
                    {id: 3, name: 'Đà Nẵng'}
                ];
                
                const options = provinces.map(p => 
                    `<option value="${p.id}">${p.name}</option>`
                ).join('');
                
                $('#addProvince, #editProvince').append(options);
            }

            function loadDistrictsAdd() {
                const provinceId = $('#addProvince').val();
                if (!provinceId) return;
                
                // TODO: Call API to get districts
                $('#addDistrict').html('<option value="">-- Chọn Quận/Huyện --</option>');
                $('#addWard').html('<option value="">-- Chọn Phường/Xã --</option>');
            }

            function loadWardsAdd() {
                const districtId = $('#addDistrict').val();
                if (!districtId) return;
                
                // TODO: Call API to get wards
                $('#addWard').html('<option value="">-- Chọn Phường/Xã --</option>');
            }

            function loadDistrictsEdit() {
                const provinceId = $('#editProvince').val();
                if (!provinceId) return;
                
                $('#editDistrict').html('<option value="">-- Chọn Quận/Huyện --</option>');
                $('#editWard').html('<option value="">-- Chọn Phường/Xã --</option>');
            }

            function loadWardsEdit() {
                const districtId = $('#editDistrict').val();
                if (!districtId) return;
                
                $('#editWard').html('<option value="">-- Chọn Phường/Xã --</option>');
            }

            function editAddress(addressId) {
                $.get('/user/address/' + addressId, function(address) {
                    $('#editAddressId').val(address.addressId);
                    $('#editFullName').val(address.fullName);
                    $('#editPhone').val(address.phone);
                    $('#editAddressDetail').val(address.addressDetail);
                    $('#editIsDefault').prop('checked', address.isDefault);
                    
                    // Load and select location
                    setTimeout(() => {
                        $('#editProvince').val(address.provinceId).trigger('change');
                        setTimeout(() => {
                            $('#editDistrict').val(address.districtId).trigger('change');
                            setTimeout(() => {
                                $('#editWard').val(address.wardId);
                            }, 500);
                        }, 500);
                    }, 500);
                    
                    new bootstrap.Modal(document.getElementById('editAddressModal')).show();
                });
            }

            function deleteAddress(addressId) {
                if (confirm('Bạn có chắc muốn xóa địa chỉ này?')) {
                    $.ajax({
                        url: '/user/address/' + addressId,
                        type: 'DELETE',
                        success: function(response) {
                            showNotification('Đã xóa địa chỉ!', 'success');
                            setTimeout(() => location.reload(), 1000);
                        },
                        error: function() {
                            showNotification('Có lỗi xảy ra!', 'error');
                        }
                    });
                }
            }

            function setDefault(addressId) {
                $.post('/user/address/' + addressId + '/set-default', function(response) {
                    if (response.success) {
                        showNotification('Đã đặt làm địa chỉ mặc định!', 'success');
                        setTimeout(() => location.reload(), 1000);
                    }
                });
            }
        </script>
    </th:block>
</body>
</html>
