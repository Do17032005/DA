<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Đơn hàng của tôi</title>
</head>
<body>
    <main layout:fragment="content">
        <div class="container my-5">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/}">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/user/profile}">Tài khoản</a></li>
                    <li class="breadcrumb-item active">Đơn hàng</li>
                </ol>
            </nav>

            <div class="row">
                <!-- Sidebar Menu -->
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                <a href="/user/profile" class="list-group-item list-group-item-action">
                                    <i class="fas fa-user me-2"></i>Thông tin tài khoản
                                </a>
                                <a href="/user/orders" class="list-group-item list-group-item-action active">
                                    <i class="fas fa-box me-2"></i>Đơn hàng của tôi
                                </a>
                                <a href="/user/address" class="list-group-item list-group-item-action">
                                    <i class="fas fa-map-marker-alt me-2"></i>Địa chỉ giao hàng
                                </a>
                                <a href="/user/vouchers" class="list-group-item list-group-item-action">
                                    <i class="fas fa-ticket-alt me-2"></i>Voucher của tôi
                                </a>
                                <a href="/wishlist" class="list-group-item list-group-item-action">
                                    <i class="fas fa-heart me-2"></i>Sản phẩm yêu thích
                                </a>
                                <a href="/user/change-password" class="list-group-item list-group-item-action">
                                    <i class="fas fa-lock me-2"></i>Đổi mật khẩu
                                </a>
                                <a href="/logout" class="list-group-item list-group-item-action text-danger">
                                    <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-md-9">
                    <!-- Page Title -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>
                            <i class="fas fa-box me-2"></i>Đơn hàng của tôi
                        </h2>
                    </div>

                    <!-- Order Filter Tabs -->
                    <ul class="nav nav-pills mb-4">
                        <li class="nav-item">
                            <a class="nav-link" th:classappend="${status == null || status == '' ? 'active' : ''}" 
                               th:href="@{/user/orders}">
                                Tất cả
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:classappend="${status == 'PENDING' ? 'active' : ''}" 
                               th:href="@{/user/orders(status='PENDING')}">
                                Chờ xác nhận
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:classappend="${status == 'PROCESSING' ? 'active' : ''}" 
                               th:href="@{/user/orders(status='PROCESSING')}">
                                Đang xử lý
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:classappend="${status == 'SHIPPING' ? 'active' : ''}" 
                               th:href="@{/user/orders(status='SHIPPING')}">
                                Đang giao
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:classappend="${status == 'COMPLETED' ? 'active' : ''}" 
                               th:href="@{/user/orders(status='COMPLETED')}">
                                Hoàn thành
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:classappend="${status == 'CANCELLED' ? 'active' : ''}" 
                               th:href="@{/user/orders(status='CANCELLED')}">
                                Đã hủy
                            </a>
                        </li>
                    </ul>

                    <!-- Empty State -->
                    <div class="text-center py-5" th:if="${orders == null || orders.empty}">
                        <i class="fas fa-box-open fa-5x text-muted mb-4"></i>
                        <h4>Chưa có đơn hàng nào</h4>
                        <p class="text-muted mb-4">Hãy bắt đầu mua sắm ngay!</p>
                        <a th:href="@{/products}" class="btn btn-primary btn-lg">
                            <i class="fas fa-shopping-bag me-2"></i>Khám phá sản phẩm
                        </a>
                    </div>

                    <!-- Orders List -->
                    <div th:if="${orders != null && !orders.empty}">
                        <div class="card border-0 shadow-sm mb-3" th:each="order : ${orders}">
                            <div class="card-header bg-light">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <strong>Mã đơn hàng: </strong>
                                        <a th:href="@{/user/orders/{id}(id=${order.orderId})}" 
                                           th:text="${order.orderCode}">
                                            #ORD-001
                                        </a>
                                        <br>
                                        <small class="text-muted">
                                            <i class="far fa-calendar me-1"></i>
                                            <span th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}">
                                                01/01/2026 10:00
                                            </span>
                                        </small>
                                    </div>
                                    <div class="col-md-6 text-md-end">
                                        <span class="badge" 
                                              th:classappend="${order.status == 'PENDING' ? 'bg-warning text-dark' : 
                                                               (order.status == 'PROCESSING' ? 'bg-info' :
                                                               (order.status == 'SHIPPING' ? 'bg-primary' :
                                                               (order.status == 'COMPLETED' ? 'bg-success' : 'bg-danger')))}">
                                            <span th:text="${order.statusText}">Chờ xác nhận</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Order Items -->
                                <div class="mb-3">
                                    <div class="d-flex mb-2 pb-2 border-bottom" 
                                         th:each="item, iterStat : ${order.items}" 
                                         th:if="${iterStat.index < 3}">
                                        <img th:src="${item.imageUrl}" 
                                             th:alt="${item.productName}"
                                             class="rounded" 
                                             style="width: 60px; height: 60px; object-fit: cover;">
                                        <div class="ms-3 flex-grow-1">
                                            <h6 class="mb-1">
                                                <a th:href="@{/products/{id}(id=${item.productId})}" 
                                                   class="text-decoration-none text-dark"
                                                   th:text="${item.productName}">
                                                    Product Name
                                                </a>
                                            </h6>
                                            <small class="text-muted">
                                                <span th:if="${item.size != null}" th:text="'Size: ' + ${item.size}"></span>
                                                <span th:if="${item.color != null}" th:text="', ' + ${item.color}"></span>
                                                <span th:text="' x ' + ${item.quantity}"></span>
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <strong class="text-danger" 
                                                    th:text="${#numbers.formatDecimal(item.price, 0, 0)} + 'đ'">
                                                299,000đ
                                            </strong>
                                        </div>
                                    </div>
                                    <div class="text-muted small" th:if="${order.items.size() > 3}">
                                        + <span th:text="${order.items.size() - 3}">2</span> sản phẩm khác
                                    </div>
                                </div>

                                <!-- Order Total -->
                                <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                                    <div>
                                        <span class="text-muted">Tổng cộng: </span>
                                        <strong class="h5 text-danger mb-0" 
                                                th:text="${#numbers.formatDecimal(order.total, 0, 0)} + 'đ'">
                                            628,000đ
                                        </strong>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <a th:href="@{/user/orders/{id}(id=${order.orderId})}" 
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye me-1"></i>Chi tiết
                                        </a>
                                        <button type="button" class="btn btn-primary btn-sm"
                                                th:if="${order.status == 'COMPLETED' && !order.hasReview}"
                                                th:onclick="'reviewOrder(' + ${order.orderId} + ')'">
                                            <i class="fas fa-star me-1"></i>Đánh giá
                                        </button>
                                        <button type="button" class="btn btn-danger btn-sm"
                                                th:if="${order.status == 'PENDING'}"
                                                th:onclick="'cancelOrder(' + ${order.orderId} + ')'">
                                            <i class="fas fa-times me-1"></i>Hủy đơn
                                        </button>
                                        <button type="button" class="btn btn-success btn-sm"
                                                th:if="${order.status == 'COMPLETED'}"
                                                th:onclick="'reorder(' + ${order.orderId} + ')'">
                                            <i class="fas fa-redo me-1"></i>Mua lại
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pagination -->
                        <nav aria-label="Orders pagination" th:if="${totalPages > 1}">
                            <ul class="pagination justify-content-center">
                                <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
                                    <a class="page-link" 
                                       th:href="@{/user/orders(page=${currentPage - 1}, status=${status})}" 
                                       aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                
                                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                    th:classappend="${i == currentPage ? 'active' : ''}"
                                    th:if="${i >= currentPage - 2 && i <= currentPage + 2}">
                                    <a class="page-link" 
                                       th:href="@{/user/orders(page=${i}, status=${status})}" 
                                       th:text="${i + 1}">1</a>
                                </li>
                                
                                <li class="page-item" th:classappend="${currentPage == totalPages - 1 ? 'disabled' : ''}">
                                    <a class="page-link" 
                                       th:href="@{/user/orders(page=${currentPage + 1}, status=${status})}" 
                                       aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <th:block layout:fragment="scripts">
        <script>
            function cancelOrder(orderId) {
                if (confirm('Bạn có chắc muốn hủy đơn hàng này?')) {
                    $.post('/user/orders/' + orderId + '/cancel', function(response) {
                        if (response.success) {
                            showNotification('Đã hủy đơn hàng thành công!', 'success');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showNotification(response.message || 'Không thể hủy đơn hàng!', 'error');
                        }
                    }).fail(function() {
                        showNotification('Có lỗi xảy ra, vui lòng thử lại!', 'error');
                    });
                }
            }

            function reviewOrder(orderId) {
                window.location.href = '/user/orders/' + orderId + '/review';
            }

            function reorder(orderId) {
                if (confirm('Bạn muốn mua lại các sản phẩm trong đơn hàng này?')) {
                    $.post('/user/orders/' + orderId + '/reorder', function(response) {
                        if (response.success) {
                            showNotification('Đã thêm sản phẩm vào giỏ hàng!', 'success');
                            setTimeout(() => window.location.href = '/cart', 1000);
                        } else {
                            showNotification(response.message || 'Có lỗi xảy ra!', 'error');
                        }
                    });
                }
            }
        </script>
    </th:block>
</body>
</html>
